import { useState } from 'react'
import toast from 'react-hot-toast'

import { pedersenHashConcat, toHex, generateProofCallData } from '../../lib/zkp/Library'
import { MerkleTree } from '../../lib/zkp/MerkleTree'
import { getFileBuffer } from '../../lib/zkp/util'
import { ICommunity } from '../../types'
import Button from '../util/button'

interface IProps {
  community: ICommunity
}

interface IState {
  community_id: string
  proof_of_interaction: string
}

const treeString =
  '0x1825c25fb8c266bb952f57ed545ee1810c1eb9a7a15561ab633acb211601ad16\n0x03c87113412a7955fb9e8516808998b38fe90da181d7929995b5863c532b4403,0x0f619a3506f17d8628c4b9d3a97a0d2e328600ab31634548c8f17efe2a949942\n0x29bd8af2513ac63a9df900f85a81e2aa278b433ff60c140c23100b4f5bd0821e,0x0ea80f54d107700ab442815bc21959ec811906658db4687b644c3aa183ba4cda,0x08d852dda382ecdcf795c6d4915ecdad87a82f745ab0806f45936793db27e08a,0x284c8d993554778a6167596430e95d1b0eeea642a26ded73c6af898d7445106a\n0x116767e107f18853c60addf9c699550070778ee16c1a87b7aa4371af9a788a86,0x1e5687b4aacf75b317b7efd2c9072a2397633264998ab48f1bef200aa0b4de8f,0x03c008f57407ec3ffa34ee2d8092b2f39430c77e64df0c1a4bb3a41d5ceb74f7,0x07c58dfd587a1253e142e469539992aada673fc04409eeacd031c988c593c4fa,0x182edf076fb8f4465f2038ba655f77b1b9ad92f461f13ef161a4f63d00df583c,0x284deb576405356728f509b6988666b17e500826168de9fd0b34b723004973b4,0x1f252b34dd0f4559b25f7e1edd37780303f1d6bcdbaf4d836d591ada5fda31a2,0x16bcef35116f6833a0cdc4640eb32fd10267c516fadeae55a94225186c70f540\n0x162c9e2bc50c0fd822141ee2ec7f93d34a33af93b7ef0f8b16a6a7ef17a89e44,0x2045a60e3fb0fd9f09fd86266f1637322abaf0694301a30df3826eff0be77f58,0x1b2d984895c98a0e7dbfee34971117d94eac3ae7101f1a7af3806f6e3347ca02,0x0ec6c75f6f539d55605139e2a0372b73b3419e518a7f6697f85d12bee19d7ee0,0x06e3b4b4d5059c95f4274d41a42916c44f7c5f6149fbb2aa0a797f97cedda903,0x239b44097155424af516c6bbeb5c24edf76fc89c6a86932bbd70fbbdfae9a1f2,0x22efc98e81d7f2bed7678cd53b1df75d80cbf3608b6986f20125cfa4a580a749,0x2243caee72e86f42f15a2fa8275a007f02c4752ed1ad11af5aef204134876ddf,0x0ece64490dd973b3f2e866c6122f91ab78469d6a35ce62025bc704a54e5756b7,0x016fe39fff437f7f991cbf3a08e182285ffeab9060a9821c9db913c11458281d,0x1da368110c96a61daef0a1f334c5613730d5d9594d4b76fb69b26eec0147a8ed,0x20fafb44662b3f98b2746369ce51019f0159345c5fac1ebfc1d5cac1551d5a51,0x0ef8a903f5404ddf04675dfb7be06047c5f7f9c1ce2dd824e57ff0c2d7ff5ef1,0x15c7aea9514cd42b5e1d7a5f3477053cbbc06d5ae3d7548410215ff84e76cd42,0x15dfb5a17c7287effda3a20075f104343cc9958fe38b8336a6d9e6116e46c5a7,0x04cfb83bf6dd8a456234b0bdf415590a04f86029d0ae1ab6bda43cfbe99eca24\n0x22c7fa99f0d46df3a87c859d87c8569cb7f89c616d9f6bc6f3f0b888621a89f6,0x0034c4f4a181710a62e2a3167e73dfca40aeec707542b97ab566e0569b7d13f0,0x00c80822f34c6b22b4a7e2923a227ac3320b78f422833418f2f9057b7e5c3b04,0x00277c7c9de676ad9e19347e14151a259a809455decd7ed3646f00b38b41aa73,0x008bc774fc1fd89408efedc563fb492332cb3896c4f7c473437e8c8b1e9d6680,0x00da9590d95615ee280738d0885270caed854084523fa7e169022260892ef6e9,0x00ba2894a62bf70d19caca928a6ad18f6074a7a01812ab09847c6803c421ffa4,0x000a85d17b5479b067caca95bd5b4c4b88e73de9ee4499be34e0c63262c79535,0x0023bd3432deeb1dc003978c73f2f3aa671f6e83ba6300608e7dbf9b137e1a70,0x00a9ec8945b3154b5b8121afca21a17e34079558142bc3c2439c339cafead4f8,0x0015b04242de944386f070b7418edeb129aea03cf1ae09086add8d47e87ebff4,0x00b0419ac54e5132810cb3299e013d2b083e8866b37cb7cb6f2fa92798472aad,0x004705a745bb82257cf8378e30c87219c1c22a166c064f43a1295cd9620e3a7a,0x00bf7d49b7a9374fd1bb08fdd3d32c8798d5c9592aed26c8f24fe064dde1ae37,0x00557581c50649d0d928b9e9355d0ec948b6785e9ce6a23631be8420a0f71681,0x0061a9ece777a25730a7edf021f863736af791cc6aba1e2ed62b1a31ed36456f,0x0021bc4e2afdb1b5895749fc10ea5f5991e57650e895d41715e5efafca061844,0x0069a7034a900314dc03618294a706fbd71d9b20f9db21f8f5b785f49a7e67f0,0x00c8f6657d3f966edbfafc4e2c135185d2dada071a509283fb5552dfb9ed08fd,0x00120216e69e95f7340d22456f79dc3e5e8a1930f87a2ecffe838739db0dcfee,0x001caa1817f0c5cb69e8616927f2887b42a8d8392a1d844323d6dc641ae0647a,0x00cbe161d994cd3a2230abb87dcc7135675232a4818152df90c2c200d5b9f268,0x0071b59822abcfd5b3215a80b9156176f528c51c44982573a11daf2eed3c9b7e,0x00adfa0594b485cae1efcd11dab221775198ee629148b8ce7bd4a17712c60e7a,0x00218317db9e4ade741d26a6f5d394331fb2cfe635e84ec4ef61edcae6de8e7d,0x009c44c8502992057a88f1c35ad2436a9cfd7669d3b4723d576f98a0f4dd8b50,0x00588045a48f55538fc3cf3343eba6edeea754b855c1d9edf32c129c182e76bc,0x00b2ee6dc9ccad09b56c9f7d433c76a12bb583462745a8aed40757a788963573,0x000d49826d66abfae244f01e13c8ebae1acb6f31e9395071cf900b53257005c8,0x00622f68e71075ca027fa92d942170f5c01a0f572968b8e7b404d60ae8b470e7,0x00ab0334e4871b174f5abc177392a1b83e8ebe306fc7b4123a66d2c0254a12f8,0x00c1b264ef859474ecf90bdbf9c2c4b2c2da693a715a4f7c5ac35b6188b34ae4'
// '0x042465fec9cff4febde35e6c03942e340356a347ded651d28b2546042d9782f3\n0x3007b459914b39fb5cd28314d7d50343e1cb4f02142045ef41c5587a0340958c,0x04dec9adcec68216767fde9e7babc6967b2b328359466d55de2f07df2885a6cb\n0x29a1c002f4560b0e3dee373d7ddb50cc8dcaa52ed00c06acc4e62ee0849ba888,0x04dfd8f16f26459bcdea3300e4a35a1653c4ef53161031aec6b57e6ba9aed2c4,0x272e5487bd9b2c30399d14157dbe5c58cdfec1e7071e8f3b33cf8f4ec12c87cd,0x20f6f9f7a5f137d720dc51ac56afc9595d192de36f44c8ae9f98b28b67c9f008\n0x240ec1d3d04a1d05aa5b62bfb092b40ccbdf10da8faab4dbb7b7febf8844d665,0x06014aa11656d8874f21accf506cb874e93ef8cc67bc427fc4fa72af26eafa50,0x08af037a36faaeaf220b4b88016559a46ecd96346c498bff697447f46e93baf0,0x28f770c081627382165d17c35847457ef3c4eafa662eb73aad6b5d7cb115f2ed,0x04a5a25ae0b971aee53058f90721740868cab9c9cf94ee623b132cb4456a140e,0x1674847aed107f600feb2d0fe0b871dde4ccd60fec9cfaef3feafd9542726d48,0x235cfbf663c2b1f4aa65552b1e32b1e233777b29dd47b46137d1d3b972347c06,0x034c503829b26d9b7efef2902067817b18acc2f58ddc223d4e7c211b0fd0558f\n0x2983a2ce455cad27ab07e596528df01c1dc450efe42908228ee3e10725087921,0x0692ccdbefd5997c2627a170a7fb495c0da88a9b9b7756d2ff993b904dbf8cc9,0x24c32cd95ad557328a963846d478247326d284f5db34f30d4bdd86f8037614e2,0x084db9bfce64a4806f5469d9e3462b1b1478a481a18ec157018e6af26a81a518,0x0252b8e385bd6f3b6f4a239f3749efc46f553f376cc82f37d73140c72c332f61,0x0a0cdff666a38fa40f323cc609f968ca52b09c2d06fa2cbf972dfed97bc24c30,0x27fe1afe6788cc2da2184ece78634ada33cf20f22c373bbd2d7f14579975cb91,0x1043e864fae646388e41079876606ca7332bad6e0e8c4f5a8785e59eeaa7ac70,0x0eaab875fed036f12181d4c081c612e6e3b0d81294041c5ecaf932c70e6a6554,0x162370202ee6455739f744342ae329ffcc5bbd612cbd0e86fd3926e77666d4d6,0x1c32e08ec4b29518ca5b969a205ec4d942ebf65a3fb2aa18acdf051c12b68144,0x119e895d814bef373fbb030a7cf1721df3deee0a7526cd3e8742239ef0ac59ba,0x1fd51f3814db676f86f9a51c75319ae282a458ad8f7e9267b3115560729ef784,0x27976a8c69585f4e14534a35126eca43cd3f1cb91b337af69174ca7a7dd77a6f,0x04bfd6a02ab6fcc38ee359dd34e51c6931269f1250c3338577e2b1cccf10856a,0x270849e9a51c17f2e6a92062c4a49dc8deb2684e3389c1c8a276a134f3283c93\n0x29dd9d30899950f919a82e61ad89d07215c48141622454e30cacb632472d7778,0x1a7ee307c9669eca6f769fcc8955392531f189774c2a572e5d688ac33f851233,0x267a18df1ba81533f0e428d34784773cf57819eb39912d33cc4cfe2412747e26,0x30164ff534b9d28de1222e9f9516420e07e30bfcff35a562f8dc23475f7c05d7,0x00636b9e0800ca2c14edd97fd3bc992c482ed86bad99d05c366d5b61bd4347b7,0x007f230e01b83c415be62ccc7f1acfaaa279b948bc0b78afde4b8ec0554c9b5e,0x00fa1ae957a5b38eb8aac08f565cd7fd674770c12d0f00e2c5c07097e6924f08,0x00c4004774e1ab68e335d230f5f917f20af2a4a5589a2b11862fa22d07190d12,0x000a1ec821cba7d22405a376a2ae9796d5b9c81116b9f3af5c54131a2b34b48f,0x000375999b5b7e86e69138939d2eb236f2b59386afdaf74b3c169fd4190caea5,0x00eaab037babf3e5375034dfa2f805f6157d6d28c27fe6a12aa197d6d4b21fa2,0x00cd6f2630f8572ee6cd5df731db906d98a8f4fa8d33ba69a0e762f90856961c,0x0094dfd5228ff48a01c2008f06e049f2bf19f4634afd5b89a1b34326a9986ba2,0x002403a0b32e152f90b700bc032a963be02b7decf3e7ffe62fcec13cde341171,0x006c160d2f4c9d0b894723d08e05fde427148032c6af77208c5dd1cf85118d6e,0x00edda74820e905efdab40543159f506e31b840f83da7909606a65a15bd6fcf2,0x00e4d3d7af177713fe65656d1cb3d3dbc578f27f79c3f02b9417dc9e6eaac5c3,0x008e0f05dcda5e65e0998e3aeba3fda24e96ddce87a072c43ca6b8a907f078f4,0x00fdcf8c5195fe771035d8941599b04552ed1829492808e2ff97e51514f38222,0x00feee1ddb41382062be61f915c262dcaf5dabc0650043483f910cebe57343e7,0x0066329c12cfa0a021ac0b2dd403d2c70296cd68ab8525c4d98d3842aa345b43,0x0099bf4cb57c089df2c24d31eb63f7982ce2e1006fd0c3869deb39e6012cf23c,0x0045c1126794b4d2ff8a663c14a3bd90aceca2950337cffa77206382bdd7bcdf,0x004b23dfe8ff6ffdf780f1a5c571f909dcfc2d319e4316fd837f42c14e4492d7,0x0071a1cb8f014e821e2c1bdcaa8e851aa278b251924fcd83033cfedf6321b7f8,0x005b2567526c93b1ab95131267b6b9b0d05b99aee7ec9d53ad5b6848e3f1f07a,0x007b8d2b3c61dc663e1179525e1af9ecf859d11d158a4da4ee03b26fb8482cf8,0x00363303f4795287e94da30f33ba3f43171517548544d636a541b4aef31e2fa2,0x00d7ba4a999665bc17182de08aa3552cba7ac33af864213dda6595047ba2efcf,0x00efd6b3ae8193cb983b263fd2b5a7831c0ec46d76eb252353179dfdeb7982bd,0x003a610c55c1934b980d0a002a0ea87503cd1e60f78465a9774eefd4b5035718,0x001847d7d8f1752cfdf6e329dfa6157e98174c6bfe7b6b42ed1230e5f726f357'

export default function GenerateProof({ community }: IProps) {
  const [proof, setProof] = useState<string>()

  const onClick = async () => {
    const secretKey = localStorage.getItem(`exitweb2/community/${community.id}`)
    if (!secretKey) return toast.error('No secret key found!')

    const communityHash = BigInt(community.hash)
    const userSecret = BigInt(secretKey)
    const computedCommitment = toHex(pedersenHashConcat(communityHash, userSecret))

    let DOMAIN = 'http://localhost:3000'
    let wasmBuff = await getFileBuffer(`${DOMAIN}/circuit.wasm`)
    let zkeyBuff = await getFileBuffer(`${DOMAIN}/circuit_final.zkey`)

    const address = '0xdef6919d69b28394B9D97FAf31b0CC2f5739ab57'

    const merkleTree = MerkleTree.createFromStorageString(treeString)

    if (!merkleTree.leafExists(BigInt(computedCommitment))) return toast.error('Commitment not found in merkle tree!')

    generateProofCallData(merkleTree, communityHash, userSecret, address, wasmBuff, zkeyBuff)
      .then(setProof)
      .then(() => toast.success('Proof generated'))
      .catch((err) => toast.error(err.message))
  }

  return (
    <div className="flex flex-col w-96 mx-auto p-4 border border-gray-300 rounded">
      <label className="text-xl font-bold">Generate a proof.</label>
      <div className="truncate mt-2"> {proof}</div>
      <Button onClick={onClick}>Generate Proof</Button>
    </div>
  )
}
